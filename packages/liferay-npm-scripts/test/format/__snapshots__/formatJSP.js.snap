// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`formatJSP() passes the blinking light test (configuration.jsp) 1`] = `
"<%--
/**
 * Copyright (c) 2000-present Liferay, Inc. All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
--%>

<%@ include file=\\"/image_gallery_display/init.jsp\\" %>

<%
DLPortletInstanceSettingsHelper dlPortletInstanceSettingsHelper = new DLPortletInstanceSettingsHelper(igRequestHelper);
%>

<liferay-portlet:actionURL portletConfiguration=\\"<%= true %>\\" var=\\"configurationActionURL\\" />

<liferay-portlet:renderURL portletConfiguration=\\"<%= true %>\\" var=\\"configurationRenderURL\\" />

<liferay-frontend:edit-form
	action=\\"<%= configurationActionURL %>\\"
	method=\\"post\\"
	name=\\"fm\\"
	onSubmit='<%= \\"event.preventDefault(); \\" + renderResponse.getNamespace() + \\"saveConfiguration();\\" %>'
>
	<aui:input name=\\"<%= Constants.CMD %>\\" type=\\"hidden\\" value=\\"<%= Constants.UPDATE %>\\" />
	<aui:input name=\\"redirect\\" type=\\"hidden\\" value=\\"<%= configurationRenderURL %>\\" />
	<aui:input name=\\"preferences--mimeTypes--\\" type=\\"hidden\\" />
	<aui:input name=\\"preferences--rootFolderId--\\" type=\\"hidden\\" value=\\"<%= rootFolderId %>\\" />

	<liferay-frontend:edit-form-body>
		<liferay-ui:error key=\\"rootFolderIdInvalid\\" message=\\"please-enter-a-valid-root-folder\\" />

		<liferay-frontend:fieldset-group>
			<liferay-frontend:fieldset
				collapsible=\\"<%= true %>\\"
				id=\\"imageGalleryDisplayDisplay\\"
				label=\\"display-settings\\"
			>
				<aui:input label=\\"show-actions\\" name=\\"preferences--showActions--\\" type=\\"checkbox\\" value=\\"<%= dlPortletInstanceSettings.isShowActions() %>\\" />

				<aui:field-wrapper label=\\"show-media-type\\">
					<liferay-ui:input-move-boxes
						leftBoxName=\\"currentMimeTypes\\"
						leftList=\\"<%= dlPortletInstanceSettingsHelper.getCurrentMimeTypes() %>\\"
						leftReorder=\\"<%= Boolean.TRUE.toString() %>\\"
						leftTitle=\\"current\\"
						rightBoxName=\\"availableMimeTypes\\"
						rightList=\\"<%= dlPortletInstanceSettingsHelper.getAvailableMimeTypes() %>\\"
						rightTitle=\\"available\\"
					/>
				</aui:field-wrapper>

				<div class=\\"display-template\\">
					<liferay-ddm:template-selector
						className=\\"<%= FileEntry.class.getName() %>\\"
						displayStyle=\\"<%= displayStyle %>\\"
						displayStyleGroupId=\\"<%= displayStyleGroupId %>\\"
						refreshURL=\\"<%= configurationRenderURL %>\\"
						showEmptyOption=\\"<%= true %>\\"
					/>
				</div>
			</liferay-frontend:fieldset>

			<liferay-frontend:fieldset
				collapsible=\\"<%= true %>\\"
				id=\\"imageGalleryDisplayFoldersListingPanel\\"
				label=\\"folders-listing\\"
			>
				<aui:field-wrapper>
					<div class=\\"form-group\\">
						<aui:input label=\\"root-folder\\" name=\\"rootFolderName\\" type=\\"resource\\" value=\\"<%= rootFolderName %>\\" />

						<aui:button name=\\"openFolderSelectorButton\\" value=\\"select\\" />

						<%
						String taglibRemoveFolder = \\"Liferay.Util.removeEntitySelection('rootFolderId', 'rootFolderName', this, '\\" + renderResponse.getNamespace() + \\"');\\";
						%>

						<aui:button disabled=\\"<%= rootFolderId <= 0 %>\\" name=\\"removeFolderButton\\" onClick=\\"<%= taglibRemoveFolder %>\\" value=\\"remove\\" />
					</div>
				</aui:field-wrapper>
			</liferay-frontend:fieldset>
		</liferay-frontend:fieldset-group>
	</liferay-frontend:edit-form-body>

	<liferay-frontend:edit-form-footer>
		<aui:button type=\\"submit\\" />

		<aui:button type=\\"cancel\\" />
	</liferay-frontend:edit-form-footer>
</liferay-frontend:edit-form>

<script>
	var openFolderSelectorButton = document.getElementById(
		'<portlet:namespace />openFolderSelectorButton'
	);

	if (openFolderSelectorButton) {
		openFolderSelectorButton.addEventListener('click', function(event) {
			Liferay.Util.selectEntity(
				{
					dialog: {
						constrain: true,
						destroyOnHide: true,
						modal: true,
						width: 680
					},
					id: '_<%= HtmlUtil.escapeJS(portletResource) %>_selectFolder',
					title:
						'<liferay-ui:message arguments=\\"folder\\" key=\\"select-x\\" />',

					<liferay-portlet:renderURL portletName=\\"<%= portletResource %>\\" var=\\"selectFolderURL\\" windowState=\\"<%= LiferayWindowState.POP_UP.toString() %>\\">
							<portlet:param name=\\"mvcRenderCommandName\\" value='<%= \\"/document_library/select_folder\\" %>' />
							<portlet:param name=\\"folderId\\" value=\\"<%= String.valueOf(rootFolderId) %>\\" />
							<portlet:param name=\\"ignoreRootFolder\\" value=\\"<%= Boolean.TRUE.toString() %>\\" />
						</liferay-portlet:renderURL>

					uri: '<%= HtmlUtil.escapeJS(selectFolderURL.toString()) %>'
				},
				function(event) {
					var folderData = {
						idString: 'rootFolderId',
						idValue: event.folderid,
						nameString: 'rootFolderName',
						nameValue: event.foldername
					};

					Liferay.Util.selectFolder(folderData, '<portlet:namespace />');
				}
			);
		});
	}

	function <portlet:namespace />saveConfiguration() {
		var form = document.<portlet:namespace />fm;

		Liferay.Util.postForm(form, {
			data: {
				mimeTypes: Liferay.Util.listSelect(
					Liferay.Util.getFormElement(form, 'currentMimeTypes')
				)
			}
		});
	}
</script>"
`;

exports[`formatJSP() passes the blinking light test (edit_template_display.jspf) 1`] = `
"<%--
/**
 * Copyright (c) 2000-present Liferay, Inc. All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
--%>

<%
String scriptContent = ParamUtil.getString(request, \\"scriptContent\\");

if (Validator.isNotNull(scriptContent)) {
	script = scriptContent;
}
%>

<aui:input cssClass=\\"hide\\" label=\\"\\" name=\\"scriptContent\\" type=\\"textarea\\" value=\\"<%= script %>\\" />

<liferay-ui:panel-container
	extended=\\"<%= true %>\\"
	id=\\"templateScriptContainer\\"
	markupView=\\"lexicon\\"
	persistState=\\"<%= true %>\\"
>
	<liferay-ui:panel
		collapsible=\\"<%= true %>\\"
		extended=\\"<%= true %>\\"
		id=\\"templateScriptSectionPanel\\"
		markupView=\\"lexicon\\"
		persistState=\\"<%= true %>\\"
		title=\\"script\\"
	>
		<div class=\\"form-group lfr-template-editor-container\\">
			<c:if test=\\"<%= ddmDisplayContext.isAutocompleteEnabled(language) %>\\">
				<div class=\\"lfr-template-palette-container pull-left\\" id=\\"<portlet:namespace />templatePaletteContainer\\">
					<div class=\\"search\\" id=\\"<portlet:namespace />paletteSearchContainer\\">
						<input class=\\"col-md-12 field form-control search-query\\" id=\\"<portlet:namespace />paletteSearch\\" placeholder=\\"<liferay-ui:message key=\\"search\\" />\\" type=\\"text\\" />
					</div>

					<div class=\\"lfr-template-palette\\" id=\\"<portlet:namespace />paletteDataContainer\\">
						<div id=\\"<portlet:namespace />paletteData\\">

							<%
							long templateHandlerClassNameId = ddmDisplay.getTemplateHandlerClassNameId(template, classNameId);

							Map<String, TemplateVariableGroup> templateVariableGroups = TemplateContextHelper.getTemplateVariableGroups(templateHandlerClassNameId, classPK, language, locale);

							TemplateHandler templateHandler = TemplateHandlerRegistryUtil.getTemplateHandler(templateHandlerClassNameId);

							Class<?> clazz = ddmDisplay.getClass();

							if (templateHandler != null) {
								clazz = templateHandler.getClass();
							}

							Bundle bundle = FrameworkUtil.getBundle(clazz);

							ResourceBundleLoader resourceBundleLoader = ResourceBundleLoaderUtil.getResourceBundleLoaderByBundleSymbolicName(bundle.getSymbolicName());

							if (resourceBundleLoader == null) {
								resourceBundleLoader = new AggregateResourceBundleLoader(ResourceBundleUtil.getResourceBundleLoader(\\"content.Language\\", clazz.getClassLoader()), LanguageResources.RESOURCE_BUNDLE_LOADER);
							}

							ResourceBundle templateHandlerResourceBundle = resourceBundleLoader.loadResourceBundle(locale);

							for (TemplateVariableGroup templateVariableGroup : templateVariableGroups.values()) {
								if (templateVariableGroup.isEmpty()) {
									continue;
								}
							%>

								<liferay-ui:panel
									collapsible=\\"<%= true %>\\"
									cssClass=\\"palette-section\\"
									extended=\\"<%= false %>\\"
									id=\\"<%= HtmlUtil.getAUICompatibleId(templateVariableGroup.getLabel()) %>\\"
									title=\\"<%= LanguageUtil.get(request, templateHandlerResourceBundle, HtmlUtil.escape(templateVariableGroup.getLabel())) %>\\"
								>
									<ul class=\\"palette-item-content\\">

										<%
										for (TemplateVariableDefinition templateVariableDefinition : templateVariableGroup.getTemplateVariableDefinitions()) {
										%>

											<li class=\\"palette-item-container\\">
												<span class=\\"palette-item\\" data-content=\\"<%= HtmlUtil.escapeAttribute(_getDataContent(templateVariableDefinition, language)) %>\\" data-title=\\"<%= HtmlUtil.escapeAttribute(_getPaletteItemTitle(request, templateHandlerResourceBundle, templateVariableDefinition)) %>\\">
													<%= HtmlUtil.escape(LanguageUtil.get(request, templateHandlerResourceBundle, templateVariableDefinition.getLabel())) %>

													<c:if test=\\"<%= templateVariableDefinition.isCollection() || templateVariableDefinition.isRepeatable() %>\\">*</c:if>
												</span>
											</li>

										<%
										}
										%>

									</ul>
								</liferay-ui:panel>

							<%
							}
							%>

						</div>
					</div>
				</div>
			</c:if>

			<%
			String editorContainerClass = \\"lfr-editor-container\\";

			if (!ddmDisplayContext.isAutocompleteEnabled(language)) {
				editorContainerClass += \\" lfr-editor-container-full\\";
			}
			%>

			<div class=\\"<%= editorContainerClass %>\\" id=\\"<portlet:namespace />editorContainer\\">
				<div class=\\"lfr-rich-editor\\" id=\\"<portlet:namespace />richEditor\\"></div>
			</div>
		</div>

		<aui:input inlineLabel=\\"left\\" label=\\"script-file\\" name=\\"script\\" type=\\"file\\" />
	</liferay-ui:panel>
</liferay-ui:panel-container>

<aui:script use=\\"aui-ace-autocomplete-freemarker,aui-ace-autocomplete-plugin,aui-ace-autocomplete-velocity,aui-toggler,aui-tooltip,autocomplete-base,autocomplete-filters,event-mouseenter,event-outside,liferay-util-window,resize,transition\\">
	var ACPlugin = A.Plugin.AceAutoComplete;
	var AObject = A.Object;
	var Util = Liferay.Util;

	var STR_EMPTY = '';

	var STR_HEIGHT = 'height';

	var selectLanguageNode = A.one('#<portlet:namespace />language');

	var panelScriptContainer = A.one('#templateScriptContainer');

	if (Util.getTop() !== A.config.win) {
		var dialog = Util.getWindow();

		if (dialog && A.Lang.isFunction(dialog._detachUIHandlesAutohide)) {
			dialog._detachUIHandlesAutohide();

			if (dialog.iframe) {
				dialog.iframe.set('closeOnEscape', false);
			}
		}
	}

	var prevEditorContent;
	var richEditor;

	<c:if test=\\"<%= ddmDisplayContext.isAutocompleteEnabled(language) %>\\">
		var paletteContainer = panelScriptContainer.one(
			'#<portlet:namespace />templatePaletteContainer'
		);
		var paletteDataContainer = panelScriptContainer.one(
			'#<portlet:namespace />paletteDataContainer'
		);

		function createLiveSearch() {
			var PaletteSearch = A.Component.create({
				AUGMENTS: [A.AutoCompleteBase],

				EXTENDS: A.Base,

				NAME: 'searchpalette',

				prototype: {
					initializer: function() {
						var instance = this;

						instance._bindUIACBase();
						instance._syncUIACBase();
					}
				}
			});

			var getItems = function() {
				var results = [];

				paletteItems.each(function(item, index) {
					results.push({
						data: item.text().trim(),
						node: item.ancestor()
					});
				});

				return results;
			};

			var getNoResultsNode = function() {
				if (!noResultsNode) {
					noResultsNode = A.Node.create(
						'<div class=\\"alert\\"><%= UnicodeLanguageUtil.get(request, \\"there-are-no-results\\") %></div>'
					);
				}

				return noResultsNode;
			};

			var paletteItems = paletteDataContainer.all('.palette-item');
			var paletteSectionsNode = paletteDataContainer.all('.palette-section');

			var noResultsNode;

			var paletteSearch = new PaletteSearch({
				inputNode: '#<portlet:namespace />paletteSearch',
				minQueryLength: 0,
				nodes: '.palette-item-container',
				resultFilters: 'phraseMatch',
				resultTextLocator: 'data',
				source: getItems()
			});

			paletteSearch.on('results', function(event) {
				paletteItems.each(function(item, index) {
					item.ancestor().addClass('hide');
				});

				event.results.forEach(function(item, index) {
					item.raw.node.removeClass('hide');
				});

				var foundVisibleSection;

				paletteSectionsNode.each(function(item, index) {
					var visibleItem = item.one('.palette-item-container:not(.hide)');

					if (visibleItem) {
						foundVisibleSection = true;
					}

					item.toggleClass('hide', !visibleItem);
				});

				var noResultsNode = getNoResultsNode();

				if (foundVisibleSection) {
					noResultsNode.remove();
				} else {
					paletteDataContainer.appendChild(noResultsNode);
				}
			});
		}

		function onPaletteItemChosen(event) {
			var editor = richEditor.getEditor();

			var item = event.currentTarget;

			var aceAutocomplete = richEditor['ace-autocomplete-plugin'];

			aceAutocomplete._lockEditor = true;

			var content = item.attr('data-content');

			var fragments = content.split('[$CURSOR$]');

			var cursorPos;
			var processed;

			AObject.each(fragments, function(item, index) {
				if (processed) {
					cursorPos = editor.getCursorPosition();
				}

				processed = true;

				editor.insert(item);
			});

			if (cursorPos) {
				editor.moveCursorToPosition(cursorPos);
			}

			editor.focus();

			aceAutocomplete._lockEditor = false;
		}
	</c:if>

	function getEditorContent() {
		var content = richEditor.getSession().getValue();

		return content;
	}

	var paletteSearchContainer = panelScriptContainer.one(
		'#<portlet:namespace />paletteSearchContainer'
	);

	function resizeEditor(event) {
		var info = event.info;

		richEditor.set(STR_HEIGHT, info.offsetHeight);
		richEditor.set('width', info.offsetWidth);

		if (!Util.isPhone()) {
			paletteDataContainer.setStyle(
				STR_HEIGHT,
				info.offsetHeight - paletteSearchContainer.height()
			);
		}
	}

	function setEditorContent(content) {
		richEditor.getSession().setValue(content);

		prevEditorContent = content;
	}

	function setEditorPlugins(event) {
		var AutoComplete;

		<c:choose>
			<c:when test=\\"<%= language.equals(TemplateConstants.LANG_TYPE_FTL) %>\\">
				AutoComplete = A.AceEditor.AutoCompleteFreemarker;
			</c:when>
			<c:when test=\\"<%= language.equals(TemplateConstants.LANG_TYPE_VM) %>\\">
				AutoComplete = A.AceEditor.AutoCompleteVelocity;
			</c:when>
		</c:choose>

		if (AutoComplete) {
			var processor = new AutoComplete({
				variables: <%= ddmDisplayContext.getAutocompleteJSON(request, language) %>
			});

			if (processor) {
				richEditor.unplug(ACPlugin);

				richEditor.plug(ACPlugin, {
					processor: processor,
					render: true,
					visible: false,
					zIndex: 10000
				});
			} else {
				richEditor.unplug(ACPlugin);
			}
		}
	}

	<%
	String langType = ParamUtil.getString(request, \\"langType\\");
	%>

	var editorContentElement = A.one('#<portlet:namespace />scriptContent');

	var editorNode = A.one('#<portlet:namespace />richEditor');

	A.on(
		'domready',
		function(event) {
			richEditor = new A.AceEditor({
				boundingBox: editorNode,
				height: 400,
				mode: '<%= EditorModeUtil.getEditorMode(langType) %>',
				width: '100%'
			}).render();

			new A.Resize({
				handles: ['br'],
				node: editorNode,
				on: {
					resize: resizeEditor
				}
			});

			if (editorContentElement) {
				setEditorContent(editorContentElement.val());
			}

			Liferay.on('<portlet:namespace />saveTemplate', function(event) {
				editorContentElement.val(getEditorContent());
			});

			selectLanguageNode.on('change', function(event) {
				Liferay.fire('<portlet:namespace />refreshEditor');
			});

			setEditorPlugins();

			<c:if test=\\"<%= ddmDisplayContext.isAutocompleteEnabled(language) %>\\">
				paletteContainer.delegate(
					'click',
					onPaletteItemChosen,
					'.palette-item'
				);

				new A.TogglerDelegate({
					animated: true,
					container: paletteDataContainer,
					content: '.palette-item-content',
					header: '.palette-item-header'
				});

				new A.TooltipDelegate({
					align: {
						points: [A.WidgetPositionAlign.LC, A.WidgetPositionAlign.RC]
					},
					duration: 0.5,
					html: true,
					position: 'right',
					trigger:
						'#<portlet:namespace />templatePaletteContainer .palette-item',
					visible: false,
					zIndex: 6
				});

				createLiveSearch();
			</c:if>
		},
		'#<portlet:namespace />richEditor'
	);

	Liferay.on('<portlet:namespace />refreshEditor', function(event) {
		var form = A.one('#<portlet:namespace />fm');

		<portlet:renderURL var=\\"refreshTemplateURL\\">
				<portlet:param name=\\"mvcPath\\" value=\\"/edit_template.jsp\\" />
			</portlet:renderURL>

		form.attr('action', '<%= refreshTemplateURL %>');

		if (
			richEditor
				.getEditor()
				.getSession()
				.getUndoManager()
				.hasUndo()
		) {
			Liferay.fire('<portlet:namespace />saveTemplate');
		}
		<c:if test=\\"<%= template == null %>\\">
			else {
				editorContentElement.val(STR_EMPTY);
			}
		</c:if>

		submitForm(form, null, null, false);
	});
</aui:script>

<%!
private String _getAccessor(String accessor, String language) {
	if (StringUtil.equalsIgnoreCase(language, \\"vm\\")) {
		if (!accessor.contains(StringPool.OPEN_PARENTHESIS)) {
			return accessor;
		}

		StringTokenizer st = new StringTokenizer(accessor, \\"(,\\");

		StringBundler sb = new StringBundler(st.countTokens() * 2);

		sb.append(st.nextToken());
		sb.append(StringPool.OPEN_PARENTHESIS);

		while (st.hasMoreTokens()) {
			sb.append(StringPool.DOLLAR);
			sb.append(st.nextToken());
		}

		accessor = sb.toString();
	}

	return accessor;
}

private String _getDataContent(TemplateVariableDefinition templateVariableDefinition, String language) {
	String dataContent = StringPool.BLANK;

	String dataType = templateVariableDefinition.getDataType();

	if (templateVariableDefinition.isCollection()) {
		TemplateVariableDefinition itemTemplateVariableDefinition = templateVariableDefinition.getItemTemplateVariableDefinition();

		dataContent = _getListCode(templateVariableDefinition.getName(), itemTemplateVariableDefinition.getName(), itemTemplateVariableDefinition.getAccessor(), language);
	}
	else if (Validator.isNull(dataType)) {
		dataContent = _getVariableReferenceCode(templateVariableDefinition.getName(), templateVariableDefinition.getAccessor(), language);
	}
	else if (dataType.equals(\\"service-locator\\")) {
		Class<?> templateVariableDefinitionClass = templateVariableDefinition.getClazz();

		String variableName = templateVariableDefinitionClass.getSimpleName();

		StringBundler sb = new StringBundler(3);

		sb.append(_getVariableAssignmentCode(variableName, \\"serviceLocator.findService(\\\\\\"\\" + templateVariableDefinition.getName() + \\"\\\\\\")\\", language));
		sb.append(\\"[$CURSOR$]\\");
		sb.append(_getVariableReferenceCode(variableName, null, language));

		dataContent = sb.toString();
	}
	else {
		try {
			String[] generateCode = templateVariableDefinition.generateCode(language);

			dataContent = generateCode[0];
		}
		catch (Exception e) {
			_log.error(e, e);
		}
	}

	return dataContent;
}

private String _getListCode(String variableName, String itemName, String accessor, String language) {
	if (StringUtil.equalsIgnoreCase(language, \\"ftl\\")) {
		StringBundler sb = new StringBundler(10);

		sb.append(\\"<#if \\");
		sb.append(variableName);
		sb.append(\\"?has_content>\\\\n\\\\t<#list \\");
		sb.append(variableName);
		sb.append(\\" as \\");
		sb.append(itemName);
		sb.append(\\">\\\\n\\\\t\\\\t\\");
		sb.append(_getVariableReferenceCode(itemName, accessor, language));
		sb.append(\\"[$CURSOR$]\\");
		sb.append(\\"\\\\n\\\\t</#list>\\\\n</#if>\\");

		return sb.toString();
	}
	else if (StringUtil.equalsIgnoreCase(language, \\"vm\\")) {
		StringBundler sb = new StringBundler(10);

		sb.append(\\"#if (!$\\");
		sb.append(variableName);
		sb.append(\\".isEmpty())\\\\n\\\\t#foreach ($\\");
		sb.append(itemName);
		sb.append(\\" in $\\");
		sb.append(variableName);
		sb.append(\\")\\\\n\\\\t\\\\t\\");
		sb.append(_getVariableReferenceCode(itemName, accessor, language));
		sb.append(\\"[$CURSOR$]\\");
		sb.append(\\"#end\\\\n#end\\");

		return sb.toString();
	}

	return StringPool.BLANK;
}

private String _getPaletteItemTitle(HttpServletRequest request, String label, Class<?> clazz) {
	StringBundler sb = new StringBundler(10);

	if (clazz == null) {
		return StringPool.BLANK;
	}

	String className = clazz.getName();

	sb.append(\\"<br />\\");
	sb.append(LanguageUtil.get(request, label));
	sb.append(StringPool.COLON);
	sb.append(\\"&nbsp;\\");

	String javadocURL = null;

	if (className.startsWith(\\"com.liferay.portal.kernel\\")) {
		javadocURL = \\"http://docs.liferay.com/portal/7.0/javadocs/portal-kernel/\\";
	}

	if (Validator.isNotNull(javadocURL)) {
		sb.append(\\"<a href=\\\\\\"\\");
		sb.append(javadocURL);
		sb.append(StringUtil.replace(className, CharPool.PERIOD, CharPool.SLASH));
		sb.append(\\".html\\\\\\" target=\\\\\\"_blank\\\\\\">\\");
	}

	sb.append(clazz.getSimpleName());

	if (Validator.isNull(javadocURL)) {
		sb.append(\\"</a>\\");
	}

	return sb.toString();
}

private String _getPaletteItemTitle(HttpServletRequest request, ResourceBundle resourceBundle, TemplateVariableDefinition templateVariableDefinition) {
	StringBundler sb = new StringBundler(12);

	String help = templateVariableDefinition.getHelp();

	if (Validator.isNotNull(help)) {
		sb.append(\\"<p>\\");
		sb.append(HtmlUtil.escape(LanguageUtil.get(request, resourceBundle, help)));
		sb.append(\\"</p>\\");
	}

	if (templateVariableDefinition.isCollection()) {
		sb.append(\\"<p><i>*\\");
		sb.append(LanguageUtil.get(request, \\"this-is-a-collection-of-fields\\"));
		sb.append(\\"</i></p>\\");
	}
	else if (templateVariableDefinition.isRepeatable()) {
		sb.append(\\"<p><i>*\\");
		sb.append(LanguageUtil.get(request, \\"this-is-a-repeatable-field\\"));
		sb.append(\\"</i></p>\\");
	}

	if (!Objects.equals(templateVariableDefinition.getDataType(), \\"service-locator\\")) {
		sb.append(LanguageUtil.get(request, \\"variable\\"));
		sb.append(StringPool.COLON);
		sb.append(\\"&nbsp;\\");
		sb.append(HtmlUtil.escape(templateVariableDefinition.getName()));
	}

	sb.append(_getPaletteItemTitle(request, \\"class\\", templateVariableDefinition.getClazz()));

	if (templateVariableDefinition.isCollection()) {
		TemplateVariableDefinition itemTemplateVariableDefinition = templateVariableDefinition.getItemTemplateVariableDefinition();

		sb.append(_getPaletteItemTitle(request, \\"items-class\\", itemTemplateVariableDefinition.getClazz()));
	}

	return sb.toString();
}

private String _getVariableAssignmentCode(String variableName, String variableValue, String language) {
	if (StringUtil.equalsIgnoreCase(language, \\"ftl\\")) {
		return \\"<#assign \\" + variableName + \\" = \\" + variableValue + \\">\\";
	}
	else if (StringUtil.equalsIgnoreCase(language, \\"vm\\")) {
		if (!variableValue.startsWith(StringPool.DOUBLE_QUOTE) && !variableValue.startsWith(StringPool.OPEN_BRACKET) && !variableValue.startsWith(StringPool.OPEN_CURLY_BRACE) && !variableValue.startsWith(StringPool.QUOTE) && !Validator.isNumber(variableValue)) {
			variableValue = StringPool.DOLLAR + variableValue;
		}

		return \\"#set ($\\" + variableName + \\" = \\" + variableValue + \\")\\";
	}

	return variableName;
}

private String _getVariableReferenceCode(String variableName, String accessor, String language) {
	String methodInvocation = StringPool.BLANK;

	if (Validator.isNotNull(accessor)) {
		methodInvocation = StringPool.PERIOD + _getAccessor(accessor, language);
	}

	if (StringUtil.equalsIgnoreCase(language, \\"ftl\\")) {
		return \\"\${\\" + variableName + methodInvocation + \\"}\\";
	}
	else if (StringUtil.equalsIgnoreCase(language, \\"vm\\")) {
		return \\"$\\" + variableName + methodInvocation;
	}

	return variableName;
}
%>

<%!
private static Log _log = LogFactoryUtil.getLog(\\"com_liferay_dynamic_data_mapping_web.edit_template_display_jspf\\");
%>
"
`;

exports[`formatJSP() passes the blinking light test (page.jsp) 1`] = `
"<!DOCTYPE html>
<html>
<head>
	<title>Test Check Source Formatting</title>
</head>
<body>
	<!-- Sort attribute values -->
	<div class=\\"foo bar\\"></div>
	<aui:nav cssClass=\\"bar abc\\"></aui:nav>

	<!-- Sort attributes -->
	<div id=\\"foo\\" class=\\"foo\\"></div>
	<div id=\\"foo\\" class=\\"foo <%= bar ? \\"bar\\" : \\"abc\\" %>\\"></div>
	<img id=\\"foo\\" class=\\"foo <%= bar ? \\"bar\\" : \\"abc\\" %>\\" />
	<aui:nav id=\\"nav\\" cssClass=\\"bar abc\\"></aui:nav>
	<aui:nav id='<%= \\"nav\\" %>' cssClass='<%= \\"bar abc\\" %>'></aui:nav>
	<span><liferay-ui:message key=\\"count\\" /> <liferay-ui:message key=\\"used-in-x-assets\\" arguments=\\"<%= tag.getAssetCount() %>\\" /></span>

	<!-- Common -->
	<!-- Invalid space -->
	<imgÂ src=\\"foo\\" />
	<!-- Mixed spaces and tabs -->
	 <div class=\\"foo\\"></div>

	<!-- Script tags -->
	<script type=\\"text\\">
		var testVar = true;
	</script>

	<aui:script>
		var testVar = true;
	</aui:script>

	<aui:script use=\\"aui-base,event,node\\">
		var Liferay = true;

		Liferay.Language.get('foo');

		Liferay.provide(window, 'testFn', function() {
			var foo = false;
		});
	</aui:script>

	<aui:script>
		<%
		List<String> foo = null;
		%>

		foo();
	</aui:script>

	<aui:script use=\\"event\\"></aui:script>

	<!-- attributes with JS -->
	<aui:nav href=\\"javascript:alert(1);\\" onClick=\\"alert(2);\\"></aui:nav>

	<!-- Style Blocks -->
	<style>
		.foo {
			border: none;
		}
	</style>

	<style></style>

	<!-- Sort attribute values JSTL -->
	<div class=\\"tab tab-title \${currentTab == tab ? 'active' : ''}\\"></div>
	<aui:nav cssClass=\\"\${currentTab == tab ? 'active' : ''} abc foo\\"></aui:nav>
	<aui:nav cssClass=\\"\${currentTab == tab ? 'active' : ''} foo abc <%= \\\\\\"scriptletblock\\\\\\" %>\\"></aui:nav>

	<style>
		.foo {
			border: none;
		}</style>

	<aui:script>
		window.foo = 'foo';
</aui:script>

	<aui:script>
		var SOME_OBJ = {
			\${foo}: 'bar',
			\${bar}: 'baz'
		};
	</aui:script>

	<aui:script require=\\"foo/bar/baz, baz/foo_bar, bar/baz/foo as FooBar\\">
		alert(fooBarBaz);
		alert(bazFoo_bar);
		alert(FooBar);
	</aui:script>

	<aui:script require=\\"\\">
</aui:script>
</body>
</html>
"
`;

exports[`formatJSP() passes the blinking light test (view_calendar_menus.jspf) 1`] = `
"<%--
/**
 * Copyright (c) 2000-present Liferay, Inc. All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
--%>

<%
String backURL = PortalUtil.getCurrentURL(request);
%>

<aui:script use=\\"aui-toggler,calendar,liferay-calendar-simple-color-picker,liferay-calendar-simple-menu,liferay-calendar-util\\">
	var calendarContainer = Liferay.component(
		'<portlet:namespace />calendarContainer'
	);

	var remoteServices = Liferay.component('<portlet:namespace />remoteServices');

	window.<portlet:namespace />calendarListsMenu = new Liferay.SimpleMenu({
		align: {
			points: [A.WidgetPositionAlign.TL, A.WidgetPositionAlign.BL]
		},
		constrain: true,
		items: [
			{
				caption: '<liferay-ui:message key=\\"add-calendar\\" />',
				fn: function(event) {
					var instance = this;

					var calendarResourceId = instance.calendarResourceId;

					if (calendarResourceId) {
						Liferay.Util.openWindow({
							dialog: {
								after: {
									destroy: function(event) {
										remoteServices.getResourceCalendars(
											calendarResourceId,
											function(calendars) {
												var calendarList =
													window
														.<portlet:namespace />calendarLists[
														calendarResourceId
													];

												calendarList.set(
													'calendars',
													calendars
												);

												<portlet:namespace />syncCalendarsMap();

												<portlet:namespace />scheduler.load();
											}
										);
									}
								},
								destroyOnHide: true,
								modal: true
							},
							refreshWindow: window,
							title: '<liferay-ui:message key=\\"add-calendar\\" />',

							<portlet:renderURL var=\\"editCalendarURL\\" windowState=\\"<%= LiferayWindowState.POP_UP.toString() %>\\">
										<portlet:param name=\\"mvcPath\\" value=\\"/edit_calendar.jsp\\" />
										<portlet:param name=\\"calendarResourceId\\" value=\\"{calendarResourceId}\\" />
									</portlet:renderURL>

							uri: Liferay.CalendarUtil.fillURLParameters(
								decodeURIComponent('<%= editCalendarURL %>'),
								{
									calendarResourceId: calendarResourceId
								}
							)
						});
					}
				},
				id: 'add'
			},
			{
				caption: '<liferay-ui:message key=\\"manage-calendars\\" />',
				fn: function(event) {
					var instance = this;

					var calendarResourceId = instance.calendarResourceId;

					if (calendarResourceId) {
						<portlet:renderURL var=\\"calendarsURL\\">
								<portlet:param name=\\"mvcPath\\" value=\\"/view_calendars.jsp\\" />
								<portlet:param name=\\"redirect\\" value=\\"<%= currentURL %>\\" />
								<portlet:param name=\\"calendarResourceId\\" value=\\"{calendarResourceId}\\" />
							</portlet:renderURL>

						window.location.href = Liferay.CalendarUtil.fillURLParameters(
							decodeURIComponent('<%= calendarsURL %>'),
							{
								calendarResourceId: calendarResourceId
							}
						);
					}
				},
				id: 'manage'
			},
			{
				caption: '<liferay-ui:message key=\\"permissions\\" />',
				fn: function(event) {
					var instance = this;

					<liferay-security:permissionsURL
							modelResource=\\"<%= CalendarConstants.RESOURCE_NAME %>\\"
							modelResourceDescription=\\"\\"
							resourcePrimKey=\\"<%= String.valueOf(scopeGroupId) %>\\"
							var=\\"permissionsURL\\"
							windowState=\\"<%= LiferayWindowState.POP_UP.toString() %>\\"
						/>

					Liferay.Util.openWindow({
						dialog: {
							destroyOnHide: true,
							modal: true
						},
						dialogIframe: {
							bodyCssClass: 'dialog-with-footer'
						},
						refreshWindow: window,
						title: '<liferay-ui:message key=\\"permissions\\" />',
						uri: decodeURIComponent('<%= permissionsURL %>')
					});
				},
				id: 'permissions'
			}
		],
		on: {
			visibleChange: function(event) {
				var instance = this;

				var hiddenItems = [];

				if (
					!(
						instance.calendarResourceId ===
						'<%= groupCalendarResource.getCalendarResourceId() %>'
					) ||
					!<%= CalendarPortletPermission.contains(permissionChecker, scopeGroupId, ActionKeys.PERMISSIONS) %>
				) {
					hiddenItems.push('permissions');
				}

				instance.set('hiddenItems', hiddenItems);
			}
		},
		visible: false,
		width: 290,
		zIndex: 500
	}).render();

	window.<portlet:namespace />calendarsMenu = {
		items: [
			{
				caption: '<liferay-ui:message key=\\"add-calendar-booking\\" />',
				fn: function(event) {
					var instance = this;

					var calendarList = instance.get('host');

					var activeCalendar = calendarList.activeItem;

					<portlet:renderURL var=\\"addCalendarBookingURL\\" windowState=\\"<%= LiferayWindowState.POP_UP.toString() %>\\">
						<portlet:param name=\\"mvcPath\\" value=\\"/edit_calendar_booking.jsp\\" />
						<portlet:param name=\\"backURL\\" value=\\"<%= backURL %>\\" />
						<portlet:param name=\\"calendarId\\" value=\\"{calendarId}\\" />
					</portlet:renderURL>

					Liferay.Util.openWindow({
						dialog: {
							after: {
								destroy: function(event) {
									<portlet:namespace />scheduler.load();
								}
							},
							destroyOnHide: true,
							modal: true
						},
						refreshWindow: window,
						title: '<liferay-ui:message key=\\"new-calendar-booking\\" />',
						uri: Liferay.CalendarUtil.fillURLParameters(
							decodeURIComponent('<%= addCalendarBookingURL %>'),
							{
								calendarId: activeCalendar.get('calendarId')
							}
						)
					});
				},
				id: 'addEvent'
			},
			{
				caption: '<liferay-ui:message key=\\"hide-calendar\\" />',
				fn: function(event) {
					var instance = this;

					var calendarList = instance.get('host');

					calendarList.remove(calendarList.activeItem);

					<portlet:namespace />refreshVisibleCalendarRenderingRules();

					instance.set('visible', false);
				},
				id: 'hide'
			},
			{
				caption: '<liferay-ui:message key=\\"calendar-settings\\" />',
				fn: function(event) {
					var instance = this;

					var calendarList = instance.get('host');

					var activeCalendar = calendarList.activeItem;

					Liferay.Util.openWindow({
						dialog: {
							after: {
								destroy: function(event) {
									remoteServices.getCalendar(
										activeCalendar.get('calendarId'),
										function(calendar) {
											var activeCalendarId = activeCalendar.get(
												'calendarId'
											);

											var calendars = calendarList
												.get('calendars')
												.map(function(item) {
													if (
														activeCalendarId ===
														item.get('calendarId')
													) {
														item = calendar;
													}

													return item;
												});

											calendarList.set(
												'calendars',
												calendars
											);

											<portlet:namespace />syncCalendarsMap();

											<portlet:namespace />scheduler.load();
										}
									);
								}
							},
							destroyOnHide: true,
							modal: true
						},
						refreshWindow: window,
						title: '<liferay-ui:message key=\\"calendar-settings\\" />',

						<portlet:renderURL var=\\"editCalendarURL\\" windowState=\\"<%= LiferayWindowState.POP_UP.toString() %>\\">
								<portlet:param name=\\"mvcPath\\" value=\\"/edit_calendar.jsp\\" />
								<portlet:param name=\\"calendarId\\" value=\\"{calendarId}\\" />
							</portlet:renderURL>

						uri: Liferay.CalendarUtil.fillURLParameters(
							decodeURIComponent('<%= editCalendarURL %>'),
							{
								calendarId: activeCalendar.get('calendarId'),
								calendarResourceId: activeCalendar.get(
									'calendarResourceId'
								)
							}
						)
					});
				},
				id: 'settings'
			},
			{
				caption: '<liferay-ui:message key=\\"permissions\\" />',
				fn: function(event) {
					var instance = this;

					var calendarList = instance.get('host');

					var activeCalendar = calendarList.activeItem;

					Liferay.Util.openWindow({
						dialog: {
							after: {
								destroy: function(event) {
									<portlet:namespace />scheduler.load();
								}
							},
							destroyOnHide: true,
							modal: true
						},
						dialogIframe: {
							bodyCssClass: 'dialog-with-footer'
						},
						refreshWindow: window,
						title: '<liferay-ui:message key=\\"permissions\\" />',

						<liferay-security:permissionsURL
								modelResource=\\"<%= Calendar.class.getName() %>\\"
								modelResourceDescription=\\"{modelResourceDescription}\\"
								resourceGroupId=\\"{resourceGroupId}\\"
								resourcePrimKey=\\"{resourcePrimKey}\\"
								var=\\"permissionsURL\\"
								windowState=\\"<%= LiferayWindowState.POP_UP.toString() %>\\"
							/>

						uri: Liferay.CalendarUtil.fillURLParameters(
							decodeURIComponent('<%= permissionsURL %>'),
							{
								modelResourceDescription: activeCalendar.get(
									'name'
								),
								resourceGroupId: activeCalendar.get('groupId'),
								resourcePrimKey: activeCalendar.get('calendarId')
							}
						)
					});
				},
				id: 'permissions'
			},
			{
				caption: '<liferay-ui:message key=\\"delete\\" />',
				fn: function(event) {
					var instance = this;

					var calendarList = instance.get('host');

					var activeCalendar = calendarList.activeItem;

					if (
						confirm(
							'<liferay-ui:message key=\\"are-you-sure-you-want-to-delete-this\\" />'
						)
					) {
						var remoteServices = Liferay.component(
							'<portlet:namespace />remoteServices'
						);

						remoteServices.deleteCalendar(
							activeCalendar.get('calendarId'),
							function() {
								remoteServices.getResourceCalendars(
									activeCalendar.get('calendarResourceId'),
									function(calendars) {
										calendarList.set('calendars', calendars);

										<portlet:namespace />syncCalendarsMap();

										<portlet:namespace />scheduler.load();

										Liferay.CalendarMessageUtil.showAlert(
											'#<portlet:namespace />alert',
											'<liferay-ui:message key=\\"the-calendar-was-deleted-successfully\\" />'
										);
									}
								);
							}
						);
					}
				},
				id: 'delete'
			},

			<c:if test=\\"<%= enableRSS %>\\">
				{
					caption: '<liferay-ui:message key=\\"rss\\" />',
					fn: function(event) {
						var instance = this;

						var calendarList = instance.get('host');

						var activeCalendar = calendarList.activeItem;

						<liferay-portlet:resourceURL id=\\"calendarBookingsRSS\\" varImpl=\\"calendarRSSURL\\">
							<portlet:param name=\\"calendarId\\" value=\\"{calendarId}\\" />
						</liferay-portlet:resourceURL>

						var url = Liferay.CalendarUtil.fillURLParameters(
							decodeURIComponent('<%= calendarRSSURL %>'),
							{
								calendarId: activeCalendar.get('calendarId')
							}
						);

						window.open(url, '_blank');

						instance.set('visible', false);
					},
					id: 'subscribe'
				},
			</c:if>

			{
				caption: '-',
				id: 'separator1'
			},
			{
				caption: '<div class=\\"calendar-portlet-color-picker\\"></div>',
				id: 'colorPicker'
			}
		],
		on: {
			visibleChange: function(event) {
				var instance = this;

				var calendarList = instance.get('host');

				var calendar = calendarList.activeItem;

				if (calendar && event.newVal) {
					var permissions = calendar.get('permissions');

					var hiddenItems = [];

					if (
						calendarList !==
						window.<portlet:namespace />otherCalendarList
					) {
						hiddenItems.push('hide');
					}

					var defaultCalendar = calendar.get('defaultCalendar');

					if (permissions.DELETE === false || defaultCalendar === true) {
						hiddenItems.push('delete');
					}

					if (permissions.MANAGE_BOOKINGS === false) {
						hiddenItems.push('addEvent');
					}

					if (permissions.PERMISSIONS === false) {
						hiddenItems.push('permissions');
					}

					if (permissions.UPDATE === false) {
						hiddenItems.push('settings');
						hiddenItems.push('separator1');
						hiddenItems.push('colorPicker');
					}

					instance.set('hiddenItems', hiddenItems);

					<portlet:namespace />colorPicker.set('host', instance);

					<portlet:namespace />colorPicker.setAttrs({
						color: calendar.get('color'),
						visible: true
					});

					var colorPickerContainer = instance
						.get('boundingBox')
						.one('.calendar-portlet-color-picker');

					colorPickerContainer.append(
						window.<portlet:namespace />colorPicker.get('boundingBox')
					);
				}
			}
		},
		width: 225
	};

	<portlet:namespace />colorPicker = new Liferay.SimpleColorPicker({
		on: {
			colorChange: function(event) {
				var instance = this;

				var simpleMenu = instance.get('host');

				if (simpleMenu) {
					var calendarList = simpleMenu.get('host');

					calendarList.activeItem.set('color', event.newVal, {
						silent: true
					});

					simpleMenu.set('visible', false);
				}
			}
		},
		visible: false
	}).render();

	A.one('#<portlet:namespace />calendarListContainer').delegate(
		'click',
		function(event) {
			var currentTarget = event.currentTarget;

			window.<portlet:namespace />calendarListsMenu.calendarResourceId = currentTarget.getAttribute(
				'data-calendarResourceId'
			);

			window.<portlet:namespace />calendarListsMenu.setAttrs({
				alignNode: currentTarget,
				toggler: currentTarget,
				visible: !window.<portlet:namespace />calendarListsMenu.get(
					'visible'
				)
			});
		},
		'.calendar-resource-arrow'
	);

	window.<portlet:namespace />toggler = new A.TogglerDelegate({
		animated: true,
		container: '#<portlet:namespace />calendarListContainer',
		content: '.calendar-portlet-calendar-list',
		header: '.calendar-portlet-list-header'
	});

	<c:if test=\\"<%= themeDisplay.isSignedIn() %>\\">
		var addOtherCalendarInput = A.one('#<portlet:namespace />addOtherCalendar');

		<liferay-portlet:resourceURL copyCurrentRenderParameters=\\"<%= false %>\\" id=\\"calendarResources\\" var=\\"calendarResourcesURL\\" />

		calendarContainer.createCalendarsAutoComplete(
			'<%= calendarResourcesURL %>',
			addOtherCalendarInput,
			function(event) {
				window.<portlet:namespace />otherCalendarList.add(event.result.raw);

				<portlet:namespace />refreshVisibleCalendarRenderingRules();

				addOtherCalendarInput.val('');
			}
		);
	</c:if>

	A.one('#<portlet:namespace />columnToggler').on('click', function(event) {
		var columnTogglerIconId = '<portlet:namespace />columnTogglerIcon';
		var columnGrid = A.one('#<portlet:namespace />columnGrid');
		var columnOptions = A.one('#<portlet:namespace />columnOptions');
		var columnTogglerIcon = A.one('#' + columnTogglerIconId);

		Liferay.Util.Session.set(
			'com.liferay.calendar.web_columnOptionsVisible',
			columnOptions.hasClass('hide')
		);

		columnGrid.toggleClass('col-md-9').toggleClass('col-md-12');

		columnOptions.toggleClass('hide');

		var newIcon = A.Node.create(
			Liferay.Util.getLexiconIconTpl(
				columnTogglerIcon._node.classList.contains(
					'lexicon-icon-caret-left'
				)
					? 'caret-right'
					: 'caret-left'
			)
		);

		newIcon.attr('id', columnTogglerIconId);

		columnTogglerIcon.replace(newIcon);
	});

	window.<portlet:namespace />refreshMiniCalendarSelectedDates = function() {
		<portlet:namespace />miniCalendar._clearSelection();

		var activeView = <portlet:namespace />scheduler.get('activeView');
		var viewDate = <portlet:namespace />scheduler.get('viewDate');

		var viewName = activeView.get('name');

		var total = 1;

		if (viewName == 'month') {
			total = A.Date.daysInMonth(viewDate);
		} else if (viewName == 'week') {
			total = 7;
		}

		var selectedDates = Liferay.CalendarUtil.getDatesList(viewDate, total);

		<portlet:namespace />miniCalendar.selectDates(selectedDates);

		var todayDate = <portlet:namespace />scheduler.get('todayDate');

		if (
			selectedDates.length > 0 &&
			DateMath.between(todayDate, selectedDates[0], selectedDates[total - 1])
		) {
			viewDate = todayDate;
		}

		<portlet:namespace />miniCalendar.set('date', viewDate);
	};

	var DateMath = A.DataType.DateMath;

	window.<portlet:namespace />refreshVisibleCalendarRenderingRules = function() {
		var miniCalendarStartDate = DateMath.subtract(
			DateMath.toMidnight(
				window.<portlet:namespace />miniCalendar.get('date')
			),
			DateMath.WEEK,
			1
		);

		var miniCalendarEndDate = DateMath.add(
			DateMath.add(
				window.<portlet:namespace />miniCalendar.get('date'),
				DateMath.MONTH,
				1
			),
			DateMath.WEEK,
			1
		);

		miniCalendarEndDate.setHours(23, 59, 59, 999);

		remoteServices.getCalendarRenderingRules(
			A.Object.keys(calendarContainer.get('visibleCalendars')),
			Liferay.CalendarUtil.toUTC(miniCalendarStartDate),
			Liferay.CalendarUtil.toUTC(miniCalendarEndDate),
			'busy',
			function(rulesDefinition) {
				var selectedDates = <portlet:namespace />miniCalendar._getSelectedDatesList();

				window.<portlet:namespace />miniCalendar.set('customRenderer', {
					filterFunction: function(date, node, rules) {
						node.addClass('lfr-busy-day');

						DateMath.toMidnight(date);

						var selected =
							selectedDates.length > 0 &&
							A.Date.isInRange(
								date,
								selectedDates[0],
								selectedDates[selectedDates.length - 1]
							);

						if (A.DataType.DateMath.isToday(date)) {
							node.addClass('lfr-current-day');
						}

						node.toggleClass('yui3-calendar-day-selected', selected);
					},
					rules: rulesDefinition
				});

				<portlet:namespace />miniCalendar.selectDates(selectedDates);
			}
		);
	};

	window.<portlet:namespace />miniCalendar = new A.Calendar({
		after: {
			dateChange: <portlet:namespace />refreshVisibleCalendarRenderingRules,
			dateClick: function(event) {
				<portlet:namespace />scheduler.setAttrs({
					date: event.date
				});
			}
		},
		date: new Date(<%= String.valueOf(date) %>),
		headerRenderer:
			'<%= HtmlUtil.escapeJS(LanguageUtil.get(request, \\"b-y\\")) %>',
		locale: '<%= themeDisplay.getLocale() %>',
		'strings.first_weekday': <%= weekStartsOn %>
	}).render('#<portlet:namespace />miniCalendarContainer');

	<portlet:namespace />scheduler.after(
		['*:add', '*:change', '*:load', '*:remove', '*:reset'],
		A.debounce(<portlet:namespace />refreshVisibleCalendarRenderingRules, 100)
	);

	<portlet:namespace />scheduler.after(
		['activeViewChange', 'dateChange'],
		<portlet:namespace />refreshMiniCalendarSelectedDates
	);

	<portlet:namespace />refreshVisibleCalendarRenderingRules();
	<portlet:namespace />refreshMiniCalendarSelectedDates();
</aui:script>
"
`;
